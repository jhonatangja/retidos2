<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operacional J&T - V27 (Motorista via Base)</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #d9534f;
            --secondary: #0275d8;
            --warning: #fd7e14;
            --success: #28a745;
            --purple: #6f42c1;
            --info: #17a2b8;
            --dark: #343a40;
            --gold: #c69500;
            --bg: #f8f9fa;
            --text: #333;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }

        header {
            background: linear-gradient(135deg, #b92b27, #1565C0);
            color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 22px; display: flex; align-items: center; gap: 10px; }
        header p { font-size: 13px; opacity: 0.9; margin-top: 5px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .card-upload {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;
        }
        .input-group { flex: 1; min-width: 250px; }
        .input-group label { display: block; font-weight: 700; margin-bottom: 8px; color: #555; font-size: 13px; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        
        .btn-main { background: var(--secondary); color: white; border: none; padding: 10px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-main:hover { background: #025aa5; }

        /* ABAS */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .nav-btn {
            background: none; border: none; padding: 10px 20px; cursor: pointer;
            font-size: 16px; font-weight: 600; color: #777; border-radius: 4px; transition: 0.2s;
        }
        .nav-btn:hover { background: #e9ecef; color: #333; }
        .nav-btn.active { background: var(--secondary); color: white; }

        #msgErro {
            background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
            padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;
        }

        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 6px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-card h3 { font-size: 10px; text-transform: uppercase; color: #777; margin-bottom: 5px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kpi-card .value { font-size: 22px; font-weight: 800; color: #333; }
        .kpi-card .sub-value { font-size: 12px; color: #777; margin-top: 5px; }
        
        .border-purple { border-left-color: var(--purple); }
        .border-orange { border-left-color: var(--warning); }
        .border-green { border-left-color: var(--success); }
        .border-red { border-left-color: var(--primary); }
        .border-info { border-left-color: var(--info); }
        .border-dark { border-left-color: var(--dark); }
        .border-gold { border-left-color: var(--gold); }
        .border-gray { border-left-color: #6c757d; }

        /* FILTROS */
        .filters-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-item { display: flex; flex-direction: column; gap: 5px; margin-right: 15px; }
        .filter-item label { font-size: 11px; font-weight: bold; color: #777; }
        .filter-item input, .filter-item select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        
        /* Dias Manual */
        .days-input-group { display: flex; gap: 5px; }
        .days-input-group select { width: 60px; min-width: 0; }
        .days-input-group input { width: 80px; }

        /* Checkbox Group */
        .checkbox-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: #f1f3f5; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .checkbox-item input { width: auto; margin: 0; cursor: pointer; }

        .main-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; align-items: start; }
        .evo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        @media (max-width: 900px) { 
            .main-grid, .evo-grid { grid-template-columns: 1fr; } 
        }

        .ranking-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100%; }
        .ranking-header { font-weight: bold; color: #333; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 16px; display:flex; align-items:center; gap:8px;}
        
        .rank-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .rank-name { font-weight: 600; color: #555; width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-bar-container { flex: 1; background: #f1f1f1; height: 8px; border-radius: 4px; margin: 0 10px; overflow: hidden; }
        .rank-bar { height: 100%; border-radius: 3px; }
        .rank-count { font-weight: bold; color: #333; width: 30px; text-align: right; }
        .bar-blue { background: var(--secondary); }
        .bar-red { background: var(--primary); }
        .bar-gold { background: var(--gold); }
        .bar-green { background: var(--success); }

        .table-container { background: white; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1000px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; color: #495057; font-weight: 700; cursor: pointer; border-bottom: 2px solid #dee2e6; }
        th:hover { background: #e2e6ea; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }

        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 10px; color: white; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-apto { background-color: var(--success); }
        .status-jt { background-color: var(--purple); }     
        .status-verify { background-color: var(--warning); } 
        .status-wait { background-color: var(--primary); }
        .status-ausencia-proc { background-color: var(--info); }
        .status-ausencia-plus { background-color: var(--gold); color: white; }
        .status-driver { background-color: var(--dark); }
        
        /* Status EvoluÃ§Ã£o */
        .evo-ok { color: var(--success); font-weight: bold; }
        .evo-pend { color: var(--primary); font-weight: bold; }

        .btn-action { background: #17a2b8; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .btn-excel { background: #218838; }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <h3>Processando...</h3>
        <p style="color:#666; font-size:12px;">Comparando bases e aplicando filtros</p>
    </div>

    <header>
        <div class="container" style="padding: 0;">
            <h1><i class="fa-solid fa-boxes-packing"></i> Dashboard J&T - V27</h1>
            <p>Filtros DinÃ¢micos | EvoluÃ§Ã£o Completa | Motorista via Base</p>
        </div>
    </header>

    <div class="container">
        
        <!-- ÃREA DE UPLOAD -->
        <div class="card-upload">
            <div class="input-group">
                <label>1. Planilha RETIDOS (A=Pedido, N=Dias, U=Motivo)</label>
                <input type="file" id="fileRetidos" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>2. Base DETALHADA (A=Ped, P=Motora, R=Data, AD=Cidade)</label>
                <input type="file" id="fileBase" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>3. Planilha EVOLUÃ‡ÃƒO (A/E/T)</label>
                <input type="file" id="fileEvolucao" accept=".csv, .xlsx, .xls">
            </div>
            <button class="btn-main" onclick="tratarClickCarregar()">
                <i class="fa-solid fa-play"></i> Carregar Tudo
            </button>
        </div>

        <!-- MENSAGEM DE ERRO -->
        <div id="msgErro"></div>

        <!-- NAVEGAÃ‡ÃƒO -->
        <div class="nav-tabs" id="navTabs" style="display:none;">
            <button class="nav-btn active" onclick="mudarAba('ops')"><i class="fa-solid fa-list-check"></i> Painel Operacional</button>
            <button class="nav-btn" onclick="mudarAba('evo')"><i class="fa-solid fa-chart-line"></i> Painel EvoluÃ§Ã£o</button>
        </div>

        <!-- ABA OPERACIONAL -->
        <div id="tabOps" class="tab-content active">
            
            <!-- FILTROS AVANÃ‡ADOS -->
            <div class="filters-bar" style="flex-direction:column; align-items:flex-start;">
                
                <div style="display:flex; width:100%; gap:15px; margin-bottom:15px; flex-wrap:wrap;">
                    <div class="filter-item" style="flex: 1;">
                        <label>Busca</label>
                        <input type="text" id="buscaGeral" placeholder="Pedido/Motorista..." onkeyup="aplicarFiltros()">
                    </div>
                    
                    <!-- FILTRO DE DIAS MANUAL -->
                    <div class="filter-item">
                        <label>Dias Retidos</label>
                        <div class="days-input-group">
                            <select id="operadorDias" onchange="aplicarFiltros()">
                                <option value="maior">></option>
                                <option value="menor"><</option>
                                <option value="igual">=</option>
                            </select>
                            <input type="number" id="valorDias" placeholder="Ex: 10" onkeyup="aplicarFiltros()">
                        </div>
                    </div>

                    <div class="filter-item" style="flex: 1;">
                        <label>Cidade</label>
                        <select id="filtroCidade" onchange="aplicarFiltros()"><option value="">Todas</option></select>
                    </div>
                    <div class="filter-item" style="flex: 1.5;">
                        <label>ProblemÃ¡tica</label>
                        <select id="filtroProblema" onchange="aplicarFiltros()"><option value="">Todas</option></select>
                    </div>
                </div>

                <div class="filter-item" style="width:100%;">
                    <label style="margin-bottom:8px; display:block;">Exibir Status (Desmarque para esconder):</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="AUSENCIA_PROCESS"> ðŸ”µ Proc. AusÃªncia</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="AUSENCIA_PLUS"> ðŸŸ¡ Ausente +1</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="APTO"> ðŸŸ¢ Aptos</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="WAIT"> ðŸ”´ Aguardando</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="VERIFY_DRIVER"> âš« Verif. Motorista</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="CHECK_JT"> ðŸŸ£ Verif. J&T</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="CHECK_VERIFY"> ðŸŸ  Verificar Outros</label>
                    </div>
                </div>
            </div>

            <!-- KPIs -->
            <div class="kpi-row">
                <div class="kpi-card border-gray"><h3>Listados</h3><div class="value" id="kpiTotal">0</div></div>
                <div class="kpi-card border-info"><h3>Proc. AusÃªncia</h3><div class="value" id="kpiAusenciaProc">0</div></div>
                <div class="kpi-card border-gold"><h3>Ausente +1</h3><div class="value" id="kpiAusenciaPlus">0</div></div>
                <div class="kpi-card border-green"><h3>Aptos DevoluÃ§Ã£o</h3><div class="value" id="kpiApto">0</div></div>
                <div class="kpi-card border-red"><h3>Aguardando Prazo</h3><div class="value" id="kpiWait">0</div></div>
                <div class="kpi-card border-dark"><h3>Verif. Motorista</h3><div class="value" id="kpiDriver">0</div></div>
                <div class="kpi-card border-purple"><h3>J&T / Outros</h3><div class="value" id="kpiOutros">0</div></div>
            </div>

            <!-- GRID OPERACIONAL -->
            <div class="main-grid">
                <div class="sidebar">
                    <div class="ranking-card"><div class="ranking-header">Top 10 Cidades</div><div id="listaTopCidades"></div></div>
                    <div class="ranking-card"><div class="ranking-header">Top 10 Problemas</div><div id="listaTopProblemas"></div></div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                        <h3>Listagem de Pedidos</h3>
                        <div>
                            <button class="btn-action" onclick="copiarCodigos()"><i class="fa-regular fa-copy"></i> Copiar</button>
                            <button class="btn-action btn-excel" onclick="exportarExcel('ops')"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                        </div>
                    </div>
                    <table id="tabelaDados">
                        <thead>
                            <tr>
                                <th onclick="ordenar('codigo')">Pedido</th>
                                <th onclick="ordenar('diasRetidos')">Dias</th>
                                <th onclick="ordenar('statusTxt')">Status</th>
                                <th onclick="ordenar('problema')">ProblemÃ¡tica</th>
                                <th onclick="ordenar('motorista')">Motorista</th>
                                <th onclick="ordenar('cidade')">Cidade</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA EVOLUÃ‡ÃƒO (COMPARATIVO) -->
        <div id="tabEvo" class="tab-content">
            
            <!-- KPIs Comparativos -->
            <div class="kpi-row" style="grid-template-columns: repeat(4, 1fr);">
                <div class="kpi-card border-gray">
                    <h3>Base Retidos (Planilha 1)</h3>
                    <div class="value" id="evoBaseTotal">0</div>
                    <div class="sub-value">Pedidos originais</div>
                </div>
                <div class="kpi-card border-green">
                    <h3>Recuperados (Entregues)</h3>
                    <div class="value" id="evoRecuperados">0</div>
                    <div class="sub-value">Encontrados na Planilha 3</div>
                </div>
                <div class="kpi-card border-red">
                    <h3>Ainda Retidos (Pendentes)</h3>
                    <div class="value" id="evoPendentes">0</div>
                    <div class="sub-value">NÃ£o entregues ainda</div>
                </div>
                <div class="kpi-card border-info">
                    <h3>EficiÃªncia de RecuperaÃ§Ã£o</h3>
                    <div class="value" id="evoEficiencia">0%</div>
                    <div class="sub-value">% da base entregue</div>
                </div>
            </div>

            <div class="evo-grid">
                <div class="ranking-card" style="border-top: 4px solid var(--success);">
                    <div class="ranking-header"><i class="fa-solid fa-truck-fast"></i> TOP 5 MOTORISTAS (Que mais recuperaram)</div>
                    <div id="evoTopMotoristas" style="padding: 10px 0;"></div>
                </div>
                <div class="ranking-card" style="border-top: 4px solid var(--secondary);">
                    <div class="ranking-header"><i class="fa-solid fa-map-location-dot"></i> TOP 5 CIDADES (Mais recuperadas)</div>
                    <div id="evoTopCidades" style="padding: 10px 0;"></div>
                </div>
            </div>

            <!-- TABELA DETALHADA EVOLUÃ‡ÃƒO -->
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                    <h3>RelatÃ³rio Detalhado de EvoluÃ§Ã£o</h3>
                    <button class="btn-action btn-excel" onclick="exportarExcel('evo')"><i class="fa-solid fa-file-excel"></i> Exportar EvoluÃ§Ã£o</button>
                </div>
                <table id="tabelaEvo">
                    <thead>
                        <tr>
                            <th onclick="ordenarEvo('codigo')">Pedido</th>
                            <th onclick="ordenarEvo('statusEvo')">SituaÃ§Ã£o</th>
                            <th onclick="ordenarEvo('diasRetidos')">Dias Retidos <i class="fa-solid fa-sort"></i></th>
                            <th onclick="ordenarEvo('motorista')">Motorista</th>
                            <th onclick="ordenarEvo('cidade')">Cidade</th>
                            <th onclick="ordenarEvo('problema')">ProblemÃ¡tica Anterior</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyEvo"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- SCRIPT LÃ“GICO -->
    <script>
        // CONFIGURAÃ‡ÃƒO DE ÃNDICES FIXOS (V27)
        // Retidos: A=Pedido, N=Dias, U=Motivo (Motorista removido)
        const IDX_RETIDOS = { pedido: 0, dias: 13, motivo: 20 };
        
        // Base: A=Pedido, P=Motorista (Novo), R=Data, AD=Cidade
        const IDX_BASE = { pedido: 0, motorista: 15, data: 17, cidade: 29 };
        
        const IDX_EVO = { pedido: 0, motorista: 4, cidade: 19 };

        const REGRA_DIAS = 9;
        const STRINGS_JT = ["aguardando.janela", "é€€å›žä»¶å¾…å®¢æˆ·å®¡æ ¸"];
        const STRINGS_VERIFY = ["encomenda.expedida", "æœ‰å‘æœªåˆ°ä»¶"];
        const TARGET_DRIVERS = ["FRQDO-JHONATAN ALVES SILVA", "FRQDO-FELIPE LOMBRE MUNDIM"];

        let dadosRaw = [];
        let dadosFiltrados = [];
        let dadosEvolucaoDetalhados = []; 
        let setRetidosOriginais = new Set(); 

        // --- SISTEMA DE ABAS ---
        function mudarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab' + (aba === 'ops' ? 'Ops' : 'Evo')).classList.add('active');
            event.target.classList.add('active');
        }

        // --- LEITURA E CARREGAMENTO ---
        function lerArquivo(arquivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(arquivo);
            });
        }

        function tratarClickCarregar() {
            const fRetidos = document.getElementById('fileRetidos').files[0];
            const fBase = document.getElementById('fileBase').files[0];
            const fEvo = document.getElementById('fileEvolucao').files[0];
            
            const divErro = document.getElementById('msgErro');
            divErro.style.display = 'none'; divErro.innerHTML = '';

            if(!fRetidos || !fBase) {
                mostrarErro("As planilhas 1 (Retidos) e 2 (Base) sÃ£o obrigatÃ³rias.");
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');

            setTimeout(async () => {
                try {
                    const retidos = await lerArquivo(fRetidos);
                    const base = await lerArquivo(fBase);
                    
                    // Processa Operacional
                    processarLogica(retidos, base);

                    // Processa EvoluÃ§Ã£o se existir
                    if(fEvo) {
                        const evoData = await lerArquivo(fEvo);
                        processarEvolucao(evoData);
                    } else {
                        dadosEvolucaoDetalhados = [];
                        renderEvolucao({ motoristas: [], cidades: [], kpis: { total: setRetidosOriginais.size, rec: 0, pen: setRetidosOriginais.size } });
                    }

                    document.getElementById('navTabs').style.display = 'flex';

                } catch (error) {
                    console.error(error);
                    mostrarErro("Erro: " + error.message);
                } finally {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            }, 200);
        }

        function mostrarErro(msg) {
            const div = document.getElementById('msgErro');
            div.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${msg}`;
            div.style.display = 'block';
        }

        function limparCodigo(val) {
            if (!val) return "";
            return String(val).trim().toUpperCase().replace(/[\s\-\.]/g, "");
        }

        // --- LÃ“GICA OPERACIONAL ---
        function processarLogica(retidos, base) {
            if (retidos.length < 2) throw new Error("Planilha RETIDOS vazia.");
            if (base.length < 2) throw new Error("Planilha BASE vazia.");

            setRetidosOriginais.clear(); 

            // 1. Mapear Base (Agora pegando Motorista aqui)
            const mapBase = new Map();
            for(let i=1; i < base.length; i++) {
                const linha = base[i];
                if (!linha || linha.length === 0) continue;
                const rawPed = linha[IDX_BASE.pedido];
                if (!rawPed) continue;
                mapBase.set(limparCodigo(rawPed), {
                    data: linha[IDX_BASE.data],
                    cidade: linha[IDX_BASE.cidade],
                    motorista: linha[IDX_BASE.motorista] // Coluna P
                });
            }

            const hoje = new Date();
            dadosRaw = [];

            // 2. Cruzar com Retidos
            for(let i=1; i < retidos.length; i++) {
                const linha = retidos[i];
                if (!linha || linha.length === 0) continue;
                const rawPed = linha[IDX_RETIDOS.pedido];
                if (!rawPed) continue;

                const codigo = limparCodigo(rawPed);
                if (codigo === "REMESSA" || codigo === "PEDIDO") continue;

                setRetidosOriginais.add(codigo);

                const diasRetidos = parseInt(linha[IDX_RETIDOS.dias]) || 0;
                let problema = String(linha[IDX_RETIDOS.motivo] || "").trim();
                
                // Busca na Base (Dados Enriquecidos)
                const match = mapBase.get(codigo);
                let cidade = "N/D";
                let diasProb = 0;
                let motorista = "N/D";

                if (match) {
                    if (match.cidade) cidade = match.cidade;
                    if (match.motorista) motorista = String(match.motorista).trim(); // Motorista da Base
                    if (match.data) {
                        const d = parseData(match.data);
                        if (d && !isNaN(d)) {
                            const diff = Math.abs(hoje - d);
                            diasProb = Math.floor(diff / (1000 * 3600 * 24));
                        }
                    }
                }

                let statusIPO = "CHECK_VERIFY";
                let statusTxt = "VERIFICAR";
                let statusClass = "status-verify";
                
                const probLower = problema.toLowerCase();
                const motoristaUpper = motorista.toUpperCase();

                if (problema === "") {
                    problema = "Sem motivo";
                    statusIPO = "VERIFY_DRIVER";
                    statusTxt = "VERIFICAR COM MOTORISTA";
                    statusClass = "status-driver";
                }
                else if (probLower.includes("recusa.de.recebimento") || probLower.includes("recusa")) {
                    statusIPO = "APTO";
                    statusTxt = "APTO DEVOLUÃ‡ÃƒO";
                    statusClass = "status-apto";
                }
                else if (probLower.includes("ausÃªncia.do.destinatÃ¡rio") || probLower.includes("ausencia")) {
                    const isTargetDriver = TARGET_DRIVERS.some(d => motoristaUpper.includes(d));
                    if (isTargetDriver) {
                        statusIPO = "AUSENCIA_PROCESS";
                        statusTxt = "EM PROCESSO DE LANÃ‡AMENTO DE AUSENCIA";
                        statusClass = "status-ausencia-proc"; 
                    } else {
                        statusIPO = "AUSENCIA_PLUS";
                        statusTxt = "AUSENTE - +1 TENTATIVA DE ENTREGA";
                        statusClass = "status-ausencia-plus"; 
                    }
                }
                else if (probLower.includes("endereÃ§o.incorreto") || probLower.includes("impossibilidade.de.chegar")) {
                    statusIPO = "WAIT";
                    statusTxt = "AGUARDANDO PRAZO";
                    statusClass = "status-wait";
                }
                else {
                    const isJT = STRINGS_JT.some(key => probLower.includes(key));
                    if (isJT) {
                        statusIPO = "CHECK_JT";
                        statusTxt = "VERIFICAR COM J&T";
                        statusClass = "status-jt";
                    } else if (diasProb > REGRA_DIAS) {
                        statusIPO = "APTO";
                        statusTxt = "APTO DEVOLUÃ‡ÃƒO";
                        statusClass = "status-apto";
                    } else {
                        statusIPO = "CHECK_VERIFY";
                        statusTxt = "VERIFICAR";
                        statusClass = "status-verify";
                    }
                }

                dadosRaw.push({ codigo, diasRetidos, problema, cidade, diasProb, motorista, statusIPO, statusTxt, statusClass });
            }

            dadosRaw.sort((a, b) => b.diasRetidos - a.diasRetidos);
            popularFiltrosAuxiliares();
            aplicarFiltros();
        }

        // --- LÃ“GICA EVOLUÃ‡ÃƒO ---
        function processarEvolucao(data) {
            const countMot = {};
            const countCid = {};
            let recuperadosCount = 0;
            const setRecuperados = new Set(); // IDs recuperados

            // 1. Identificar quem foi entregue (que estava retido)
            for(let i=1; i < data.length; i++) {
                const linha = data[i];
                if(!linha || linha.length === 0) continue;

                const rawPed = linha[IDX_EVO.pedido];
                if(!rawPed) continue;
                const codigo = limparCodigo(rawPed);

                if (setRetidosOriginais.has(codigo)) {
                    recuperadosCount++;
                    setRecuperados.add(codigo);

                    const mot = String(linha[IDX_EVO.motorista] || "N/D").trim().toUpperCase();
                    const cid = String(linha[IDX_EVO.cidade] || "N/D").trim().toUpperCase();

                    if(mot !== "N/D") countMot[mot] = (countMot[mot] || 0) + 1;
                    if(cid !== "N/D") countCid[cid] = (countCid[cid] || 0) + 1;
                }
            }

            // 2. Montar Tabela Detalhada de EvoluÃ§Ã£o (COM DIAS E MOTORISTA DO RETIDO)
            dadosEvolucaoDetalhados = dadosRaw.map(r => {
                const entregue = setRecuperados.has(r.codigo);
                return {
                    codigo: r.codigo,
                    motorista: r.motorista, // Motorista que reteve
                    cidade: r.cidade,
                    problema: r.problema,
                    diasRetidos: r.diasRetidos, // ADICIONADO
                    statusEvo: entregue ? "ENTREGUE" : "PENDENTE",
                    classeEvo: entregue ? "evo-ok" : "evo-pend"
                };
            });

            // Ordena: Pendentes primeiro, depois por dias retidos decrescente
            dadosEvolucaoDetalhados.sort((a,b) => {
                if (a.statusEvo !== b.statusEvo) return a.statusEvo === "PENDENTE" ? -1 : 1;
                return b.diasRetidos - a.diasRetidos; // Quem tem mais dias primeiro
            });

            // 3. Renderizar GrÃ¡ficos
            const topMot = Object.entries(countMot).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const topCid = Object.entries(countCid).sort((a,b) => b[1] - a[1]).slice(0, 5);

            renderEvolucao({ 
                motoristas: topMot, 
                cidades: topCid,
                kpis: {
                    total: setRetidosOriginais.size, 
                    rec: recuperadosCount,           
                    pen: setRetidosOriginais.size - recuperadosCount 
                }
            });
            renderTabelaEvo();
        }

        function renderEvolucao(dados) {
            const elMot = document.getElementById('evoTopMotoristas');
            const elCid = document.getElementById('evoTopCidades');
            const k = dados.kpis;
            
            document.getElementById('evoBaseTotal').innerText = k.total;
            document.getElementById('evoRecuperados').innerText = k.rec;
            document.getElementById('evoPendentes').innerText = k.pen;
            
            const eff = k.total > 0 ? ((k.rec / k.total) * 100).toFixed(1) : 0;
            document.getElementById('evoEficiencia').innerText = eff + "%";

            elMot.innerHTML = "";
            elCid.innerHTML = "";

            if(!dados.motoristas || dados.motoristas.length === 0) {
                const msg = "<div style='color:#999; text-align:center; padding:20px'>Sem dados</div>";
                elMot.innerHTML = msg; elCid.innerHTML = msg; return;
            }

            const maxMot = dados.motoristas[0][1];
            dados.motoristas.forEach(([nome, qtd], idx) => {
                const pct = (qtd / maxMot) * 100;
                elMot.innerHTML += `<div class="rank-row"><div style="font-weight:bold; width:20px; color:#555;">#${idx+1}</div><div class="rank-name" style="width:50%" title="${nome}">${nome}</div><div class="rank-bar-container"><div class="rank-bar bar-green" style="width: ${pct}%"></div></div><div class="rank-count">${qtd}</div></div>`;
            });

            const maxCid = dados.cidades[0][1];
            dados.cidades.forEach(([nome, qtd], idx) => {
                const pct = (qtd / maxCid) * 100;
                elCid.innerHTML += `<div class="rank-row"><div style="font-weight:bold; width:20px; color:#555;">#${idx+1}</div><div class="rank-name" style="width:50%" title="${nome}">${nome}</div><div class="rank-bar-container"><div class="rank-bar bar-blue" style="width: ${pct}%"></div></div><div class="rank-count">${qtd}</div></div>`;
            });
        }

        function renderTabelaEvo() {
            const tbody = document.getElementById('tbodyEvo');
            tbody.innerHTML = "";
            const lista = dadosEvolucaoDetalhados.slice(0, 500); // Limitador visual
            
            lista.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.codigo}</td>
                    <td class="${r.classeEvo}">${r.statusEvo}</td>
                    <td style="font-weight:bold; text-align:center;">${r.diasRetidos}</td>
                    <td>${r.motorista}</td>
                    <td>${r.cidade}</td>
                    <td style="font-size:11px; color:#777;">${r.problema}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- UTILS COMUNS ---
        function parseData(val) {
            if (!val) return null;
            if (val instanceof Date) return val;
            if (typeof val === 'number') return new Date(Math.round((val - 25569) * 86400 * 1000));
            if (typeof val === 'string') {
                if (val.match(/^\d{4}-\d{2}-\d{2}/)) return new Date(val);
                if (val.includes('/')) {
                    const parts = val.split(' ')[0].split('/');
                    if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            return new Date(val);
        }

        function popularFiltrosAuxiliares() {
            const cidades = [...new Set(dadosRaw.map(d => d.cidade))].filter(c => c && c !== "N/D").sort();
            const problemas = [...new Set(dadosRaw.map(d => d.problema))].filter(p => p).sort();
            const selCidade = document.getElementById('filtroCidade');
            const selProb = document.getElementById('filtroProblema');
            selCidade.innerHTML = '<option value="">Todas</option>';
            selProb.innerHTML = '<option value="">Todas</option>';
            cidades.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; selCidade.appendChild(opt); });
            problemas.forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.innerText = p.length > 60 ? p.substring(0,60)+"..." : p; selProb.appendChild(opt); });
        }

        function aplicarFiltros() {
            const busca = document.getElementById('buscaGeral').value.toLowerCase();
            const cityFilter = document.getElementById('filtroCidade').value;
            const probFilter = document.getElementById('filtroProblema').value;
            
            // Filtro Dias Manual
            const opDias = document.getElementById('operadorDias').value;
            const valDias = document.getElementById('valorDias').value;

            // Checkboxes
            const checkedStatus = Array.from(document.querySelectorAll('.checkbox-item input:checked')).map(cb => cb.value);

            dadosFiltrados = dadosRaw.filter(d => {
                const matchTxt = d.codigo.toLowerCase().includes(busca) || d.motorista.toLowerCase().includes(busca);
                const matchCity = cityFilter ? d.cidade === cityFilter : true;
                const matchProb = probFilter ? d.problema === probFilter : true;
                const matchSt = checkedStatus.includes(d.statusIPO);
                
                let matchDias = true;
                if(valDias !== "") {
                    const v = parseInt(valDias);
                    if(opDias === "maior") matchDias = d.diasRetidos > v;
                    else if(opDias === "menor") matchDias = d.diasRetidos < v;
                    else if(opDias === "igual") matchDias = d.diasRetidos === v;
                }

                return matchTxt && matchSt && matchCity && matchProb && matchDias;
            });
            atualizarKPIs();
            renderTabela();
            renderTopLists();
        }

        function atualizarKPIs() {
            setKPI('kpiTotal', dadosFiltrados.length);
            setKPI('kpiAusenciaProc', dadosFiltrados.filter(d => d.statusIPO === 'AUSENCIA_PROCESS').length);
            setKPI('kpiAusenciaPlus', dadosFiltrados.filter(d => d.statusIPO === 'AUSENCIA_PLUS').length);
            setKPI('kpiApto', dadosFiltrados.filter(d => d.statusIPO === 'APTO').length);
            setKPI('kpiWait', dadosFiltrados.filter(d => d.statusIPO === 'WAIT').length);
            setKPI('kpiDriver', dadosFiltrados.filter(d => d.statusIPO === 'VERIFY_DRIVER').length);
            setKPI('kpiOutros', dadosFiltrados.filter(d => ['CHECK_JT', 'CHECK_VERIFY'].includes(d.statusIPO)).length);
        }

        function setKPI(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }

        function renderTabela() {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = "";
            const lista = dadosFiltrados.slice(0, 500);
            lista.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><b>${r.codigo}</b></td><td style="font-weight:bold;">${r.diasRetidos}</td><td><span class="badge ${r.statusClass}">${r.statusTxt}</span></td><td style="font-size:12px; color:#555;">${r.problema}</td><td style="font-size:11px;">${r.motorista}</td><td>${r.cidade}</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderTopLists() {
            renderRank('listaTopCidades', 'cidade', 'bar-blue');
            renderRank('listaTopProblemas', 'problema', 'bar-red');
        }

        function renderRank(elId, key, colorClass) {
            const container = document.getElementById(elId);
            container.innerHTML = "";
            const counts = {};
            dadosFiltrados.forEach(d => {
                const val = d[key] || "N/D";
                counts[val] = (counts[val] || 0) + 1;
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (sorted.length === 0) { container.innerHTML = "<div style='color:#999; text-align:center;'>Sem dados</div>"; return; }
            const max = sorted[0][1];
            sorted.forEach(([nome, qtd]) => {
                const pct = (qtd / max) * 100;
                container.innerHTML += `<div class="rank-row"><div class="rank-name" title="${nome}">${nome}</div><div class="rank-bar-container"><div class="rank-bar ${colorClass}" style="width: ${pct}%"></div></div><div class="rank-count">${qtd}</div></div>`;
            });
        }

        let sortDir = 'desc';
        function ordenar(key) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            dadosFiltrados.sort((a,b) => {
                let vA = a[key], vB = b[key];
                if(typeof vA === 'string') { vA = vA.toLowerCase(); vB = vB.toLowerCase(); }
                if(vA < vB) return sortDir === 'asc' ? -1 : 1;
                if(vA > vB) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });
            renderTabela();
        }

        // OrdenaÃ§Ã£o especÃ­fica da Aba EvoluÃ§Ã£o
        let sortDirEvo = 'desc';
        function ordenarEvo(key) {
            sortDirEvo = sortDirEvo === 'asc' ? 'desc' : 'asc';
            dadosEvolucaoDetalhados.sort((a,b) => {
                let vA = a[key], vB = b[key];
                if(typeof vA === 'string') { vA = vA.toLowerCase(); vB = vB.toLowerCase(); }
                if(vA < vB) return sortDirEvo === 'asc' ? -1 : 1;
                if(vA > vB) return sortDirEvo === 'asc' ? 1 : -1;
                return 0;
            });
            renderTabelaEvo();
        }

        function copiarCodigos() {
            if (dadosFiltrados.length === 0) { alert("Nenhum pedido filtrado."); return; }
            const codigos = dadosFiltrados.map(d => d.codigo).join("\n");
            const textArea = document.createElement("textarea");
            textArea.value = codigos;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); alert(dadosFiltrados.length + " cÃ³digos copiados!"); } 
            catch (err) { alert("Erro ao copiar."); }
            document.body.removeChild(textArea);
        }

        function exportarExcel(tipo) {
            let data, nome;
            if(tipo === 'ops') {
                data = dadosFiltrados.map(d => ({ "Pedido": d.codigo, "Dias Retidos": d.diasRetidos, "Status": d.statusTxt, "Motivo": d.problema, "Motorista": d.motorista, "Cidade": d.cidade }));
                nome = "Relatorio_Operacional.xlsx";
            } else {
                data = dadosEvolucaoDetalhados.map(d => ({ "Pedido": d.codigo, "SituaÃ§Ã£o": d.statusEvo, "Dias Retidos": d.diasRetidos, "Motorista (Ret)": d.motorista, "Cidade": d.cidade, "Problema": d.problema }));
                nome = "Relatorio_Evolucao.xlsx";
            }
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, nome);
        }
    </script>
</body>
</html>