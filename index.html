<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operacional J&T - V30 (Bot√£o Vis√≠vel)</title>
    
    <!-- SheetJS inclu√≠do via CDN -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #d9534f; --secondary: #0275d8; --warning: #fd7e14; --success: #28a745;
            --purple: #6f42c1; --info: #17a2b8; --dark: #343a40; --gold: #c69500; --bg: #f8f9fa; --text: #333;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }
        header { background: linear-gradient(135deg, #b92b27, #1565C0); color: white; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        header h1 { font-size: 22px; display: flex; align-items: center; gap: 10px; }
        header p { font-size: 13px; opacity: 0.9; margin-top: 5px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .card-upload { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
        .input-group { flex: 1; min-width: 250px; }
        .input-group label { display: block; font-weight: 700; margin-bottom: 8px; color: #555; font-size: 13px; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .btn-main { background: var(--secondary); color: white; border: none; padding: 10px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        .btn-main:hover { background: #025aa5; }
        .btn-share { background: #6f42c1; } /* Bot√£o roxo */
        .btn-share:hover { background: #5a32a3; }

        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .nav-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; font-weight: 600; color: #777; border-radius: 4px; transition: 0.2s; }
        .nav-btn:hover { background: #e9ecef; color: #333; }
        .nav-btn.active { background: var(--secondary); color: white; }

        #msgErro { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }

        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 6px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-card h3 { font-size: 10px; text-transform: uppercase; color: #777; margin-bottom: 5px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kpi-card .value { font-size: 22px; font-weight: 800; color: #333; }
        .kpi-card .sub-value { font-size: 12px; color: #777; margin-top: 5px; }
        
        .border-purple { border-left-color: var(--purple); } .border-orange { border-left-color: var(--warning); }
        .border-green { border-left-color: var(--success); } .border-red { border-left-color: var(--primary); }
        .border-info { border-left-color: var(--info); } .border-dark { border-left-color: var(--dark); }
        .border-gold { border-left-color: var(--gold); } .border-gray { border-left-color: #6c757d; }

        .filters-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-item { display: flex; flex-direction: column; gap: 5px; margin-right: 15px; }
        .filter-item label { font-size: 11px; font-weight: bold; color: #777; }
        .filter-item input, .filter-item select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        .days-input-group { display: flex; gap: 5px; }
        .days-input-group select { width: 60px; min-width: 0; }
        .days-input-group input { width: 80px; }
        .checkbox-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: #f1f3f5; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .checkbox-item input { width: auto; margin: 0; cursor: pointer; }

        .main-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; align-items: start; }
        .evo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .main-grid, .evo-grid { grid-template-columns: 1fr; } }

        .ranking-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100%; }
        .ranking-header { font-weight: bold; color: #333; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 16px; display:flex; align-items:center; gap:8px;}
        .rank-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .rank-name { font-weight: 600; color: #555; width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-bar-container { flex: 1; background: #f1f1f1; height: 8px; border-radius: 4px; margin: 0 10px; overflow: hidden; }
        .rank-bar { height: 100%; border-radius: 3px; }
        .rank-count { font-weight: bold; color: #333; width: 30px; text-align: right; }
        .bar-blue { background: var(--secondary); } .bar-red { background: var(--primary); }
        .bar-gold { background: var(--gold); } .bar-green { background: var(--success); }

        .table-container { background: white; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1000px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; color: #495057; font-weight: 700; cursor: pointer; border-bottom: 2px solid #dee2e6; }
        th:hover { background: #e2e6ea; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }

        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 10px; color: white; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-apto { background-color: var(--success); } .status-jt { background-color: var(--purple); }
        .status-verify { background-color: var(--warning); } .status-wait { background-color: var(--primary); }
        .status-ausencia-proc { background-color: var(--info); } .status-ausencia-plus { background-color: var(--gold); color: white; }
        .status-driver { background-color: var(--dark); }
        .evo-ok { color: var(--success); font-weight: bold; } .evo-pend { color: var(--primary); font-weight: bold; }

        .btn-action { background: #17a2b8; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .btn-excel { background: #218838; }
        .btn-cobranca { background: #fd7e14; color: white; font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 500px; max-width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .close-btn { cursor: pointer; color: #aaa; font-size: 20px; }
        .modal-body textarea { width: 100%; height: 200px; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; font-family: monospace; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <h3>Processando...</h3>
        <p style="color:#666; font-size:12px;">Identificando modelo e cruzando dados</p>
    </div>

    <!-- MODAL COBRAN√áA -->
    <div id="modalCobranca" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span><i class="fa-brands fa-whatsapp"></i> Gerar Cobran√ßa</span>
                <span class="close-btn" onclick="fecharModalCobranca()">&times;</span>
            </div>
            <div class="modal-body">
                <label>Selecione o Motorista:</label>
                <select id="selMotoristaCobranca" onchange="gerarTextoCobranca()" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <option value="">-- Selecione --</option>
                </select>
                <textarea id="txtAreaCobranca"></textarea>
                <button class="btn-main" style="width: 100%; margin-top: 10px;" onclick="copiarTextoCobranca()">
                    <i class="fa-regular fa-copy"></i> Copiar Texto
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="container" style="padding: 0;">
            <h1><i class="fa-solid fa-boxes-packing"></i> Dashboard J&T - V30 (Port√°til)</h1>
            <p>Gerador de Dashboard com Dados Inclusos</p>
        </div>
    </header>

    <div class="container">
        
        <!-- √ÅREA DE UPLOAD (S√≥ aparece se N√ÉO tiver dados pr√©-carregados) -->
        <div class="card-upload" id="areaUpload">
            <div class="input-group">
                <label>1. Planilha RETIDOS (Auto Detect)</label>
                <input type="file" id="fileRetidos" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>2. Base DETALHADA (A/P/R/AD)</label>
                <input type="file" id="fileBase" accept=".csv, .xlsx, .xls">
            </div>
            <div class="input-group">
                <label>3. Planilha EVOLU√á√ÉO (A/E/T)</label>
                <input type="file" id="fileEvolucao" accept=".csv, .xlsx, .xls">
            </div>
            <!-- BOTOES LADO A LADO -->
            <div style="display:flex; gap:10px; align-items: flex-end;">
                <button class="btn-main" onclick="tratarClickCarregar()">
                    <i class="fa-solid fa-play"></i> Carregar
                </button>
                <!-- BOT√ÉO VIS√çVEL AGORA -->
                <button class="btn-main btn-share" id="btnGerarPortatil" onclick="gerarHTMLPortatil()">
                    <i class="fa-solid fa-download"></i> Salvar c/ Dados
                </button>
            </div>
        </div>

        <div id="msgErro"></div>

        <div class="nav-tabs" id="navTabs" style="display:none;">
            <button class="nav-btn active" onclick="mudarAba('ops')"><i class="fa-solid fa-list-check"></i> Operacional</button>
            <button class="nav-btn" onclick="mudarAba('evo')"><i class="fa-solid fa-chart-line"></i> Evolu√ß√£o</button>
        </div>

        <div id="tabOps" class="tab-content active">
            <div class="filters-bar" style="flex-direction:column; align-items:flex-start;">
                <div style="display:flex; width:100%; gap:15px; margin-bottom:15px; flex-wrap:wrap;">
                    <div class="filter-item" style="flex: 1;"><label>Busca</label><input type="text" id="buscaGeral" placeholder="Pedido/Motorista..." onkeyup="aplicarFiltros()"></div>
                    <div class="filter-item"><label>Dias Retidos</label>
                        <div class="days-input-group">
                            <select id="operadorDias" onchange="aplicarFiltros()"><option value="maior">></option><option value="menor"><</option><option value="igual">=</option></select>
                            <input type="number" id="valorDias" placeholder="Ex: 10" onkeyup="aplicarFiltros()">
                        </div>
                    </div>
                    <div class="filter-item" style="flex: 1;"><label>Cidade</label><select id="filtroCidade" onchange="aplicarFiltros()"><option value="">Todas</option></select></div>
                    <div class="filter-item" style="flex: 1.5;"><label>Problem√°tica</label><select id="filtroProblema" onchange="aplicarFiltros()"><option value="">Todas</option></select></div>
                </div>
                <div class="filter-item" style="width:100%;">
                    <label style="margin-bottom:8px; display:block;">Status:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="AUSENCIA_PROCESS"> üîµ Proc. Aus√™ncia</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="AUSENCIA_PLUS"> üü° Ausente +1</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="APTO"> üü¢ Aptos</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="WAIT"> üî¥ Aguardando</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="VERIFY_DRIVER"> ‚ö´ Verif. Motorista</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="CHECK_JT"> üü£ Verif. J&T</label>
                        <label class="checkbox-item"><input type="checkbox" checked onchange="aplicarFiltros()" value="CHECK_VERIFY"> üü† Outros</label>
                    </div>
                </div>
            </div>

            <div class="kpi-row">
                <div class="kpi-card border-gray"><h3>Listados</h3><div class="value" id="kpiTotal">0</div></div>
                <div class="kpi-card border-info"><h3>Proc. Aus√™ncia</h3><div class="value" id="kpiAusenciaProc">0</div></div>
                <div class="kpi-card border-gold"><h3>Ausente +1</h3><div class="value" id="kpiAusenciaPlus">0</div></div>
                <div class="kpi-card border-green"><h3>Aptos Devolu√ß√£o</h3><div class="value" id="kpiApto">0</div></div>
                <div class="kpi-card border-red"><h3>Aguardando</h3><div class="value" id="kpiWait">0</div></div>
                <div class="kpi-card border-dark"><h3>Verif. Motorista</h3><div class="value" id="kpiDriver">0</div></div>
                <div class="kpi-card border-purple"><h3>J&T / Outros</h3><div class="value" id="kpiOutros">0</div></div>
            </div>

            <div class="main-grid">
                <div class="sidebar">
                    <div class="ranking-card"><div class="ranking-header">Top 10 Cidades</div><div id="listaTopCidades"></div></div>
                    <div class="ranking-card"><div class="ranking-header">Top 10 Problemas</div><div id="listaTopProblemas"></div></div>
                </div>
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                        <h3>Listagem</h3>
                        <div>
                            <button class="btn-action btn-cobranca" onclick="abrirModalCobranca()"><i class="fa-brands fa-whatsapp"></i> Cobrar</button>
                            <button class="btn-action" onclick="copiarCodigos()"><i class="fa-regular fa-copy"></i> Copiar</button>
                            <button class="btn-action btn-excel" onclick="exportarExcel('ops')"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                        </div>
                    </div>
                    <table id="tabelaDados">
                        <thead>
                            <tr>
                                <th onclick="ordenar('codigo')">Pedido</th>
                                <th onclick="ordenar('diasRetidos')">Dias</th>
                                <th onclick="ordenar('statusTxt')">Status</th>
                                <th onclick="ordenar('problema')">Problem√°tica</th>
                                <th onclick="ordenar('motorista')">Motorista</th>
                                <th onclick="ordenar('cidade')">Cidade</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabEvo" class="tab-content">
            <div class="kpi-row" style="grid-template-columns: repeat(4, 1fr);">
                <div class="kpi-card border-gray"><h3>Base Retidos</h3><div class="value" id="evoBaseTotal">0</div></div>
                <div class="kpi-card border-green"><h3>Recuperados</h3><div class="value" id="evoRecuperados">0</div></div>
                <div class="kpi-card border-red"><h3>Pendentes</h3><div class="value" id="evoPendentes">0</div></div>
                <div class="kpi-card border-info"><h3>Efici√™ncia</h3><div class="value" id="evoEficiencia">0%</div></div>
            </div>
            <div class="evo-grid">
                <div class="ranking-card" style="border-top: 4px solid var(--success);">
                    <div class="ranking-header">TOP 5 RECUPERADORES</div><div id="evoTopMotoristas"></div>
                </div>
                <div class="ranking-card" style="border-top: 4px solid var(--secondary);">
                    <div class="ranking-header">TOP 5 CIDADES RECUPERADAS</div><div id="evoTopCidades"></div>
                </div>
            </div>
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                    <h3>Relat√≥rio Evolu√ß√£o</h3>
                    <button class="btn-action btn-excel" onclick="exportarExcel('evo')"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                </div>
                <table id="tabelaEvo">
                    <thead>
                        <tr>
                            <th onclick="ordenarEvo('codigo')">Pedido</th>
                            <th onclick="ordenarEvo('statusEvo')">Situa√ß√£o</th>
                            <th onclick="ordenarEvo('diasRetidos')">Dias Ret.</th>
                            <th onclick="ordenarEvo('motorista')">Motorista</th>
                            <th onclick="ordenarEvo('cidade')">Cidade</th>
                            <th onclick="ordenarEvo('problema')">Problem√°tica</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyEvo"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DADOS EMBUTIDOS (SER√ÉO PREENCHIDOS PELO SCRIPT) -->
    <script id="dados-injetados" type="application/json">null</script>

    <script>
        // CONFIGURA√á√ïES (V30)
        const MODELO_1 = { pedido: 0, motivo: 4, dias: 6 }; 
        const MODELO_2 = { pedido: 0, dias: 13, motivo: 20 }; 
        const IDX_BASE = { pedido: 0, motorista: 15, data: 17, cidade: 29 };
        const IDX_EVO = { pedido: 0, motorista: 4, cidade: 19 };
        const REGRA_DIAS = 9;
        const TARGET_DRIVERS = ["FRQDO-JHONATAN ALVES SILVA", "FRQDO-FELIPE LOMBRE MUNDIM"];
        const STRINGS_JT = ["aguardando.janela", "ÈÄÄÂõû‰ª∂ÂæÖÂÆ¢Êà∑ÂÆ°Ê†∏"];
        const STRINGS_VERIFY = ["encomenda.expedida", "ÊúâÂèëÊú™Âà∞‰ª∂"];

        let dadosRaw = [];
        let dadosFiltrados = [];
        let dadosEvolucaoDetalhados = []; 
        let setRetidosOriginais = new Set();
        let idxRetidosAtivo = MODELO_2; 

        // --- INICIALIZA√á√ÉO AUTOM√ÅTICA ---
        window.onload = function() {
            const dadosPreCarregados = JSON.parse(document.getElementById('dados-injetados').textContent);
            if (dadosPreCarregados) {
                console.log("Dados pr√©-carregados encontrados!");
                document.getElementById('areaUpload').style.display = 'none';
                
                dadosRaw = dadosPreCarregados.dadosRaw;
                dadosEvolucaoDetalhados = dadosPreCarregados.dadosEvolucaoDetalhados;
                
                dadosRaw.forEach(d => setRetidosOriginais.add(d.codigo));

                popularFiltrosAuxiliares();
                aplicarFiltros();
                recalcularTotaisEvolucaoSalva();
                renderTabelaEvo();

                document.getElementById('navTabs').style.display = 'flex';
                document.getElementById('painelPrincipal').classList.remove('hidden'); // Fix para exibir
                mudarAba('ops'); 
            }
        };

        function recalcularTotaisEvolucaoSalva() {
            const countMot = {}, countCid = {};
            let rec = 0;
            dadosEvolucaoDetalhados.forEach(d => {
                if(d.statusEvo === 'ENTREGUE') {
                    rec++;
                    const m = d.motorista || "N/D"; const c = d.cidade || "N/D";
                    countMot[m] = (countMot[m]||0)+1; countCid[c] = (countCid[c]||0)+1;
                }
            });
            const topMot = Object.entries(countMot).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const topCid = Object.entries(countCid).sort((a,b)=>b[1]-a[1]).slice(0,5);
            
            renderEvolucao({ 
                motoristas: topMot, cidades: topCid,
                kpis: { total: dadosEvolucaoDetalhados.length, rec: rec, pen: dadosEvolucaoDetalhados.length - rec }
            });
        }

        // --- FUN√á√ÉO PARA GERAR O HTML PORT√ÅTIL ---
        function gerarHTMLPortatil() {
            if(dadosRaw.length === 0) {
                alert("Carregue os dados primeiro antes de salvar o painel.");
                return;
            }

            let htmlContent = document.documentElement.outerHTML;
            const dadosParaSalvar = {
                dadosRaw: dadosRaw,
                dadosEvolucaoDetalhados: dadosEvolucaoDetalhados
            };
            const jsonString = JSON.stringify(dadosParaSalvar);
            const scriptTagRegex = /<script id="dados-injetados" type="application\/json">([\s\S]*?)<\/script>/;
            const novoScriptTag = `<script id="dados-injetados" type="application/json">${jsonString}<\/script>`;
            
            htmlContent = htmlContent.replace(scriptTagRegex, novoScriptTag);

            const blob = new Blob([htmlContent], {type: "text/html"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "Dashboard_J&T_Completo_" + new Date().toISOString().slice(0,10) + ".html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- MANIPULA√á√ÉO DE ABAS E UI ---
        function mudarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab' + (aba === 'ops' ? 'Ops' : 'Evo')).classList.add('active');
            event.target.classList.add('active');
        }

        function abrirModalCobranca() {
            const motoristas = [...new Set(dadosRaw.map(d => d.motorista))].filter(m => m && m !== "N/D").sort();
            const sel = document.getElementById('selMotoristaCobranca');
            sel.innerHTML = '<option value="">-- Selecione o Motorista --</option>';
            motoristas.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.innerText = m; sel.appendChild(opt); });
            document.getElementById('modalCobranca').style.display = 'flex';
            document.getElementById('txtAreaCobranca').value = "";
        }
        function fecharModalCobranca() { document.getElementById('modalCobranca').style.display = 'none'; }
        
        function gerarTextoCobranca() {
            const motorista = document.getElementById('selMotoristaCobranca').value;
            if(!motorista) return;
            const pendencias = dadosRaw.filter(d => d.motorista === motorista && d.statusIPO !== 'APTO');
            if(pendencias.length === 0) { document.getElementById('txtAreaCobranca').value = "Nenhuma pend√™ncia encontrada."; return; }
            let texto = `*OL√Å ${motorista}!*\n\nConstam *${pendencias.length}* pacotes pendentes de regulariza√ß√£o:\n\n`;
            pendencias.forEach(p => { texto += `üì¶ *${p.codigo}* (${p.diasRetidos} dias)\n‚ö†Ô∏è ${p.problema}\nüìç ${p.cidade}\n\n`; });
            texto += "Favor regularizar o quanto antes.";
            document.getElementById('txtAreaCobranca').value = texto;
        }
        function copiarTextoCobranca() {
            const txt = document.getElementById('txtAreaCobranca'); txt.select(); document.execCommand('copy'); alert("Texto copiado!");
        }

        // --- L√ìGICA DE DADOS (IMPORTA√á√ÉO) ---
        function lerArquivo(arquivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject; reader.readAsArrayBuffer(arquivo);
            });
        }

        function tratarClickCarregar() {
            const fRetidos = document.getElementById('fileRetidos').files[0];
            const fBase = document.getElementById('fileBase').files[0];
            const fEvo = document.getElementById('fileEvolucao').files[0];
            if(!fRetidos || !fBase) { mostrarErro("Arquivos 1 e 2 s√£o obrigat√≥rios."); return; }
            document.getElementById('loadingOverlay').classList.remove('hidden');
            setTimeout(async () => {
                try {
                    const retidos = await lerArquivo(fRetidos);
                    const base = await lerArquivo(fBase);
                    detectarModeloRetidos(retidos);
                    processarLogica(retidos, base);
                    if(fEvo) {
                        const evoData = await lerArquivo(fEvo);
                        processarEvolucao(evoData);
                    } else {
                        dadosEvolucaoDetalhados = [];
                        renderEvolucao({ motoristas: [], cidades: [], kpis: { total: setRetidosOriginais.size, rec: 0, pen: setRetidosOriginais.size } });
                    }
                    document.getElementById('navTabs').style.display = 'flex';
                } catch (error) { console.error(error); mostrarErro(error.message); } 
                finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
            }, 200);
        }

        function detectarModeloRetidos(dados) {
            if(!dados || dados.length === 0) return;
            const header = dados[0].map(c => String(c).toLowerCase());
            const colG = header[6] || ""; const colN = header[13] || "";
            if (colG.includes("dias") || colG.includes("reten√ß√£o")) idxRetidosAtivo = MODELO_1;
            else if (colN.includes("dias") || colN.includes("retidos")) idxRetidosAtivo = MODELO_2;
            else { /* Fallback */ if (header[4] && header[4].includes("tipo")) idxRetidosAtivo = MODELO_1; else idxRetidosAtivo = MODELO_2; }
        }

        function processarLogica(retidos, base) {
            setRetidosOriginais.clear();
            const mapBase = new Map();
            for(let i=1; i < base.length; i++) {
                const l = base[i]; if(!l || l.length===0) continue;
                const ped = limparCodigo(l[IDX_BASE.pedido]);
                mapBase.set(ped, { data: l[IDX_BASE.data], cidade: l[IDX_BASE.cidade], motorista: l[IDX_BASE.motorista] });
            }
            const hoje = new Date();
            dadosRaw = [];
            
            for(let i=1; i < retidos.length; i++) {
                const l = retidos[i]; if(!l || l.length===0) continue;
                const ped = limparCodigo(l[idxRetidosAtivo.pedido]);
                if(ped === "REMESSA" || ped === "PEDIDO") continue;
                setRetidosOriginais.add(ped);

                const dias = parseInt(l[idxRetidosAtivo.dias]) || 0;
                let prob = String(l[idxRetidosAtivo.motivo] || "").trim();
                const match = mapBase.get(ped);
                
                let cid = "N/D", mot = "N/D", dProb = 0;
                if(match) {
                    if(match.cidade) cid = match.cidade;
                    if(match.motorista) mot = String(match.motorista).trim();
                    if(match.data) {
                        const d = parseData(match.data);
                        if(d && !isNaN(d)) dProb = Math.floor(Math.abs(hoje - d) / (8.64e7));
                    }
                }

                // Status Logic
                let stIPO = "CHECK_VERIFY", stTxt = "VERIFICAR", stClass = "status-verify";
                const pLow = prob.toLowerCase(); const mUp = mot.toUpperCase();

                if(prob === "") { prob="Sem motivo"; stIPO="VERIFY_DRIVER"; stTxt="VERIFICAR COM MOTORISTA"; stClass="status-driver"; }
                else if(pLow.includes("recusa")) { stIPO="APTO"; stTxt="APTO DEVOLU√á√ÉO"; stClass="status-apto"; }
                else if(pLow.includes("aus√™ncia") || pLow.includes("ausencia")) {
                    if(TARGET_DRIVERS.some(d => mUp.includes(d))) { stIPO="AUSENCIA_PROCESS"; stTxt="EM PROCESSO DE AUSENCIA"; stClass="status-ausencia-proc"; }
                    else { stIPO="AUSENCIA_PLUS"; stTxt="AUSENTE +1"; stClass="status-ausencia-plus"; }
                }
                else if(pLow.includes("endere√ßo") || pLow.includes("impossibilidade")) { stIPO="WAIT"; stTxt="AGUARDANDO PRAZO"; stClass="status-wait"; }
                else {
                    if(STRINGS_JT.some(k => pLow.includes(k))) { stIPO="CHECK_JT"; stTxt="VERIFICAR J&T"; stClass="status-jt"; }
                    else if(dias > REGRA_DIAS) { stIPO="APTO"; stTxt="APTO DEVOLU√á√ÉO"; stClass="status-apto"; }
                    else { stIPO="CHECK_VERIFY"; stTxt="VERIFICAR"; stClass="status-verify"; }
                }
                dadosRaw.push({ codigo: ped, diasRetidos: dias, problema: prob, cidade: cid, diasProb: dProb, motorista: mot, statusIPO: stIPO, statusTxt: stTxt, statusClass: stClass });
            }
            dadosRaw.sort((a,b) => b.diasRetidos - a.diasRetidos);
            popularFiltrosAuxiliares(); aplicarFiltros();
        }

        function processarEvolucao(data) {
            const setRec = new Set();
            for(let i=1; i < data.length; i++) {
                const l = data[i]; if(!l) continue;
                const ped = limparCodigo(l[IDX_EVO.pedido]);
                if(setRetidosOriginais.has(ped)) setRec.add(ped);
            }
            
            dadosEvolucaoDetalhados = dadosRaw.map(r => {
                const entr = setRec.has(r.codigo);
                return {
                    codigo: r.codigo, motorista: r.motorista, cidade: r.cidade, problema: r.problema, diasRetidos: r.diasRetidos,
                    statusEvo: entr ? "ENTREGUE" : "PENDENTE", classeEvo: entr ? "evo-ok" : "evo-pend"
                };
            });
            dadosEvolucaoDetalhados.sort((a,b) => (a.statusEvo === b.statusEvo) ? (b.diasRetidos - a.diasRetidos) : (a.statusEvo === "PENDENTE" ? -1 : 1));
            
            recalcularTotaisEvolucaoSalva();
            renderTabelaEvo();
        }

        // UTILS
        function limparCodigo(val) { return val ? String(val).trim().toUpperCase().replace(/[\s\-\.]/g, "") : ""; }
        function mostrarErro(m) { const d = document.getElementById('msgErro'); d.innerHTML = m; d.style.display = 'block'; }
        function parseData(val) {
            if(!val) return null; if(val instanceof Date) return val;
            if(typeof val === 'number') return new Date(Math.round((val-25569)*86400000));
            if(typeof val === 'string') {
                if(val.match(/^\d{4}-\d{2}-\d{2}/)) return new Date(val);
                if(val.includes('/')) { const p = val.split(' ')[0].split('/'); return new Date(p[2], p[1]-1, p[0]); }
            } return new Date(val);
        }
        function popularFiltrosAuxiliares() {
            const c = [...new Set(dadosRaw.map(d=>d.cidade))].sort(), p = [...new Set(dadosRaw.map(d=>d.problema))].sort();
            const sc = document.getElementById('filtroCidade'), sp = document.getElementById('filtroProblema');
            sc.innerHTML='<option value="">Todas</option>'; sp.innerHTML='<option value="">Todas</option>';
            c.forEach(x=>sc.add(new Option(x,x))); p.forEach(x=>sp.add(new Option(x.substring(0,60),x)));
        }
        function aplicarFiltros() {
            const b = document.getElementById('buscaGeral').value.toLowerCase();
            const fc = document.getElementById('filtroCidade').value, fp = document.getElementById('filtroProblema').value;
            const op = document.getElementById('operadorDias').value, vd = document.getElementById('valorDias').value;
            const chk = Array.from(document.querySelectorAll('.checkbox-item input:checked')).map(x=>x.value);
            
            dadosFiltrados = dadosRaw.filter(d => {
                const mt = d.codigo.toLowerCase().includes(b) || d.motorista.toLowerCase().includes(b);
                const mc = fc ? d.cidade === fc : true; const mp = fp ? d.problema === fp : true;
                const ms = chk.includes(d.statusIPO);
                let md = true;
                if(vd) { const v = parseInt(vd); if(op==='maior') md=d.diasRetidos>v; else if(op==='menor') md=d.diasRetidos<v; else md=d.diasRetidos===v; }
                return mt && mc && mp && ms && md;
            });
            atualizarKPIs(); renderTabela(); renderTopLists();
        }
        function renderTabela() {
            const tb = document.getElementById('tbody'); tb.innerHTML="";
            dadosFiltrados.slice(0,500).forEach(r => {
                tb.innerHTML += `<tr><td>${r.codigo}</td><td style="font-weight:bold">${r.diasRetidos}</td><td><span class="badge ${r.statusClass}">${r.statusTxt}</span></td><td style="font-size:12px">${r.problema}</td><td style="font-size:11px">${r.motorista}</td><td>${r.cidade}</td></tr>`;
            });
        }
        function atualizarKPIs() {
            const k = (id, f) => document.getElementById(id).innerText = dadosFiltrados.filter(f).length;
            document.getElementById('kpiTotal').innerText = dadosFiltrados.length;
            k('kpiAusenciaProc', d=>d.statusIPO==='AUSENCIA_PROCESS'); k('kpiAusenciaPlus', d=>d.statusIPO==='AUSENCIA_PLUS');
            k('kpiApto', d=>d.statusIPO==='APTO'); k('kpiWait', d=>d.statusIPO==='WAIT');
            k('kpiDriver', d=>d.statusIPO==='VERIFY_DRIVER'); k('kpiOutros', d=>['CHECK_JT','CHECK_VERIFY'].includes(d.statusIPO));
        }
        function renderTopLists() {
            const r = (id, k, c) => {
                const ct={}; dadosFiltrados.forEach(d=>{ if(d[k]!=='N/D') ct[d[k]]=(ct[d[k]]||0)+1; });
                const s = Object.entries(ct).sort((a,b)=>b[1]-a[1]).slice(0,5);
                const el = document.getElementById(id); el.innerHTML=""; const max = s[0]?s[0][1]:1;
                s.forEach(([n,q]) => el.innerHTML+=`<div class="rank-row"><div class="rank-name" title="${n}">${n}</div><div class="rank-bar-container"><div class="rank-bar ${c}" style="width:${(q/max)*100}%"></div></div><div class="rank-count">${q}</div></div>`);
            };
            r('listaTopCidades','cidade','bar-blue'); r('listaTopProblemas','problema','bar-red');
        }
        function ordenar(k){ dadosFiltrados.sort((a,b)=>(a[k]>b[k]?1:-1)); renderTabela(); }
        function ordenarEvo(k){ dadosEvolucaoDetalhados.sort((a,b)=>(a[k]>b[k]?1:-1)); renderTabelaEvo(); }
        function copiarCodigos() { const t=document.createElement("textarea"); t.value=dadosFiltrados.map(d=>d.codigo).join("\n"); document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); alert("Copiado!"); }
        function exportarExcel(t) {
            const dt = t==='ops' ? dadosFiltrados : dadosEvolucaoDetalhados;
            const ws = XLSX.utils.json_to_sheet(dt); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Dados"); XLSX.writeFile(wb,"Relatorio.xlsx");
        }
    </script>
</body>
</html>